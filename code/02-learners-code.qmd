---
title: "Training session code: Significance testing"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

### Packages you need

```{r setup}
#| include: false
# R packages
library(here)
library(tidyverse)
library(googlesheets4)
library(janitor)
library(patchwork)
```

### Set up data

```{r}
# Create a sequence of x values (chi-square values)
x <- seq(0, 120, length.out = 500)

# Choose degrees of freedom to illustrate
dfs <- seq(1:12)

# Create data frame of densities for each df
chi_data <- expand.grid(x = x, df = dfs) |> 
  mutate(density = dchisq(x, df))
```

### Is what we observed extreme enough to cause a fuss?

```{r}
chi_pdf_by_k_test_statistic_region <- function(
  k, 
  x_val = NULL, 
  y_max = 0.5, 
  stitle = "Shaded area = P(X â‰¥ x)", 
  p_value = NULL, 
  show_title = TRUE
) {
  
  # Filter for one df
  data_df <- chi_data |> filter(df == k)
  
  # Title logic
  main_title <- if (show_title) {
    bquote("Chi-square probability density function for df = " ~ .(k))
  } else {
    NULL
  }
  
  # Base plot
  p <- ggplot(data_df, aes(x = x, y = density)) +
    geom_line(colour = "steelblue", size = 1.2) +
    coord_cartesian(ylim = c(0, y_max)) +
    labs(
      title = main_title,
      x = expression(chi^2~"value"),
      y = "Density"
    ) +
    theme_bw(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold")
    )
  
  # Add shading if x_val is provided
  if (!is.null(x_val)) {
    shade_data <- data.frame(x = seq(x_val, max(data_df$x), length.out = 200))
    shade_data$y <- dchisq(shade_data$x, k)
    
    p <- p +
      geom_area(data = shade_data, aes(x = x, y = y),
                fill = "tomato", alpha = 0.5) +
      geom_vline(xintercept = x_val, linetype = "dashed", colour = "grey40") +
      annotate("text", x = x_val, y = y_max * 0.9, 
               label = paste0("Chi-squared test statistic = ", x_val), 
               hjust = -0.1, colour = "grey40") +
      labs(subtitle = stitle)
    
    # Optional p-value label
    if (!is.null(p_value)) {
      p <- p +
        annotate("text", 
                 x = x_val, 
                 y = y_max * 0.8, 
                 label = paste0("p-value = ", signif(p_value, 3)),
                 hjust = -0.1,
                 colour = "black",
                 fontface = "italic")
    }
  }
  
  print(p)
}

chi_pdf_by_k_test_statistic_region(k = 8, x_val = 10) +
  coord_cartesian(c(0,30))

ggsave(here("outputs/figures/gta_pdf_k8_x10.pdf"), width = 6, height = 5)
```

### Exercise 

```{r}
# URL
anu_wg <- read_sheet("https://docs.google.com/spreadsheets/d/1th1g7rIm8CnAasC4ZW63fgBe2uYE0Q7uDpPZyC67IP0/edit?gid=0#gid=0",
           range = "B1:E11") |> 
  clean_names() |>
  mutate(location = "ANU Wagga Wagga")

uoa <- read_sheet("https://docs.google.com/spreadsheets/d/1th1g7rIm8CnAasC4ZW63fgBe2uYE0Q7uDpPZyC67IP0/edit?gid=0#gid=0",
           range = "B15:E25") |> 
  clean_names() |> 
  mutate(location = "Uni of Adelaide")

anu_cbr <- read_sheet("https://docs.google.com/spreadsheets/d/1th1g7rIm8CnAasC4ZW63fgBe2uYE0Q7uDpPZyC67IP0/edit?gid=0#gid=0",
           range = "B29:E39") |> 
  clean_names() |>
  mutate(location = "ANU Canberra")

# Combine together
workshop_data <- bind_rows(anu_wg,uoa, anu_cbr) |> 
  relocate(location, .before = brand_of_chocolate) 

```


```{r}
overall_data <- workshop_data |> 
  summarise(
    chi_sq_statistic = sum(discrepancy) |> round(2),
    p_value = pchisq(chi_sq_statistic, df = 8, lower.tail = FALSE)
    ) 

  
chi_pdf_by_k_test_statistic_region(k = 8,
                                   y_max = 0.12,
                                   x_val = overall_data$chi_sq_statistic,
                                   p_value = overall_data$p_value
                                   ) + 
  coord_cartesian(c(0,110))
```


```{r}
grouped_data <- workshop_data |> 
  group_by(location) |> 
  summarise(chi_sq_statistic = sum(discrepancy) |> round(2),
            p_value = pchisq(chi_sq_statistic, df = 8, lower.tail = FALSE)
    ) 
  
pmap(
  .l = grouped_data,
  .f = function(location, chi_sq_statistic, p_value){
    chi_pdf_by_k_test_statistic_region(k = 8, 
                                       x_val = chi_sq_statistic, 
                                       y_max = 0.12, 
                                       stitle = location,
                                       p_value = p_value,
                                       show_title = FALSE)
  } ) |>  
  wrap_plots()
```
