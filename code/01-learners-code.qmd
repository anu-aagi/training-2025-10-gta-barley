---
title: "Training session code: Future Crops x GTA"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

### Packages you need

```{r}
# R packages
library(here)
library(readxl)
library(janitor)
library(tidyverse)
library(patchwork)
```

### Load raw data

```{r}
# Load data
raw_data <- read_excel(here("data/data-raw/Copy of GTA Assesment Protocol Test_Zoomagri_ShrdMrsdn.xlsx"), sheet = "Clean") |> 
  clean_names() |> # Turn all column names to lower, snake case
  rename(result_1_percent = percent_12, # Give percent results a more relevant name
         result_2_percent = percent_14,
         result_3_percent = percent_16)
```

### If in doubt, count it out

```{r}
raw_data |> 
  count(workstation)

raw_data |> 
  count(sample_code) |> 
  print(n = 50)

raw_data_cursory_clean <- raw_data |> 
  drop_na(workstation, sample_code) |> # Exclude NA in workstation and sample code
  filter(str_detect(sample_code, "Mix|Pure")) |>  # Retain relevant analyses
  mutate(sample_code =  # Collapse the repeats from GTAPure10
           case_when(
             str_detect(sample_code, "Repeat") ~ "GTAPure10",
             .default = sample_code
                      ),
         ) 


raw_data_cursory_clean |> 
  tabyl(workstation, sample_code) |> 
  tibble()
```

### Drop dead weight

```{r}
raw_data_cursory_clean |> 
  janitor::get_one_to_one() 

raw_data_cursory_clean |> 
  janitor::remove_constant(quiet = FALSE)

raw_data_cursory_clean |> 
  count(number_samples, expected_result) 

raw_data_drop_dead_weight <- raw_data_cursory_clean |> 
  janitor::remove_constant(quiet = FALSE) |>  # Remove variables that are not adding information
  select(-c(pc_id, s_n, analysis_id, ends_with("date"))) # Retain the key variables I need
```


### Take and make what you need

```{r}
raw_data_tidy <- raw_data_drop_dead_weight |> 
  mutate(obs_id = 1:n()) |> 
  pivot_longer(cols = c(result_1, result_2, result_3),
               values_to = "variety",
               names_to = "result") |> 
  pivot_longer(cols = starts_with("result_"),
               names_to = "result_percent",
               values_to = "percent") |> 
  filter(result == str_remove(result_percent, "_percent")) |> 
  mutate(result_top = str_remove(result, "result_")) |> 
  select(-result, -result_percent)  |> 
  filter(!is.na(variety)) 

raw_data_tidy |> 
  View()
```

```{r}
# Add in missing varieties where their percentage would be 0
varieties <- c("Planet", "Spartacus CL", "Westminster", "Bass", "Maximus CL", 
               "La Trobe", "Commodus CL")

# Create a zero dataframe for all varieties
varieties_zero <- expand_grid(variety = varieties, percent = 0, obs_id = unique(raw_data_tidy$obs_id))

# Find the instances where they are missing zero and for which variety
missing_zeroes <- varieties_zero |> 
  anti_join(select(raw_data_tidy, variety, percent, starts_with("result"), obs_id), by = c("obs_id", "variety"))

# Join these onto the original tidy data and sort my observation id (smallest to largest)
gta_input <- bind_rows(raw_data_tidy, missing_zeroes) |> 
  arrange(obs_id) |> 
  fill(-result_top)
```

```{r}
# Add in the 'truth' expected percentages
truth <- tribble(~sample_code, ~variety, ~percent_truth,
                 "GTAPure1", "Bass", 100,
                 "GTAPure2", "La Trobe", 100,
                 "GTAPure3", "Maximus CL", 100,
                 "GTAPure4", "Commodus CL", 100,
                 "GTAPure5", "Spartacus CL", 100,
                 "GTAPure6", "Westminster", 100,
                 "GTAPure7", "Planet", 100,
                 "GTAPure8", "Bass", 100,
                 "GTAPure9", "La Trobe", 100,
                 "GTAPure10", "Maximus CL", 100,
                 "GTAPure11", "Commodus CL", 100,
                 "GTAPure12", "Spartacus CL", 100,
                 "GTAMix1", "Bass", 85,
                 "GTAMix1", "Maximus CL", 15,
                 "GTAMix2", "Planet", 85,
                 "GTAMix2", "Bass", 15,
                 "GTAMix3", "Spartacus CL", 80,
                 "GTAMix3", "Bass", 20,
                 "GTAMix4", "La Trobe", 80,
                 "GTAMix4", "Maximus CL", 20,
                 "GTAMix5", "La Trobe", 75,
                 "GTAMix5", "Planet", 25,
                 "GTAMix6", "Maximus CL", 75,
                 "GTAMix6", "Planet", 25,
                 "GTAMix7", "Spartacus CL", 70,
                 "GTAMix7", "Planet", 30,
                 "GTAMix8", "Planet", 70,
                 "GTAMix8", "Maximus CL", 30,
                 "GTAMix9", "Bass", 65,
                 "GTAMix9", "La Trobe", 35,
                 "GTAMix10", "Maximus CL", 65,
                 "GTAMix10", "Bass", 35,
                 "GTAMix11", "Maximus CL", 60,
                 "GTAMix11", "La Trobe", 40,
                 "GTAMix12", "Planet", 50,
                 "GTAMix12", "Spartacus CL", 50)


# Left join the truth to the recorded data
gta_with_expected_percent <- gta_input |> 
  left_join(truth, by = c("variety", "sample_code")) |> 
  mutate(percent_truth = ifelse(is.na(percent_truth) & sample_code %in% truth$sample_code, 0, percent_truth)) |>  # Set percent truth to 0 if NA
  relocate(percent_truth, .after = percent) # Move column next to percent

gta_with_expected_percent |> 
  View()
```

```{r}
gta_valid <- gta_with_expected_percent |> 
  mutate(predicted_seeds = round(percent/100 * classified_seeds),
         expected_seeds = round(percent_truth/100 * classified_seeds), 
         sample_type = case_when(str_detect(sample_code, "Pure") ~ "Pure", # Two level variable denoting Pure or Mix
                                 str_detect(sample_code, "Mix") ~ "Mix",
                                 .default = "Other"),
         obs_id = as.character(obs_id)) |> 
  rename(predicted_percent = percent,  # Rename variables to more relevant to experimental protocol
         expected_percent = percent_truth) |> 
  mutate(variety = fct_relevel(variety, "Others", after = Inf),
         raw_sample_code = sample_code,
         sample_code = factor(sample_code, levels = unique(truth$sample_code)))

gta_valid |> 
  View()

saveRDS(gta_valid, here("data/data-valid/data-valid-training.rds"))
```

### Explore your question with visuals

#### Efficacy in identification and consistency across devices

##### Single station - pure sample

```{r}
gtapure6_percent <- gta_valid |> 
  filter(sample_code == "GTAPure6",
         workstation == "Deniliquin"
         ) |> 
  select(workstation, sample_code, obs_id, variety, ends_with("percent"), result_top) |> 
  pivot_longer(ends_with("percent"), 
               names_to = "result_type",
               values_to = "percentage"
               ) |> 
  mutate(result_type = str_remove(result_type, "_percent"),
         result_type = fct_relevel(result_type, "predicted", "expected")
         ) |> 
  ggplot(aes(result_type, percentage, fill=variety)) +
  geom_bar(position="stack", stat="identity") +
  ggtitle("Device: Deniliquin for sample GTAPure6") + 
  xlab("Result type") + 
  ylab("Percentage identified (%)") + 
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) 

ggsave(here("outputs/figures/gta_deniliquin_pure6_percent.pdf"), gtapure6_percent, width = 6, height = 5)
```

##### Single station - mixed sample

```{r}
# Admixed samples
gta_valid |> 
  filter(
    sample_code == "GTAMix4",
    workstation == "Piangil"
         ) |> 
  select(workstation, sample_code, obs_id, variety, ends_with("percent"), result_top) |> 
  pivot_longer(ends_with("percent"), 
               names_to = "result_type",
               values_to = "percentage"
               ) |> 
   mutate(result_type = str_remove(result_type, "_percent"),
         result_type = fct_relevel(result_type, "predicted", "expected")
         ) |> 
  ggplot(aes(result_type, percentage, fill=variety)) +
  geom_bar(position="stack", stat="identity") +
  ggtitle("Device Piangil for sample GTAMix4") + 
  xlab("Result type") + 
  ylab("Percentage identified (%)") + 
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave(here("outputs/figures/gta_piangil_pure4_percent.pdf"), width = 6, height = 5)
```


```{r}
# Pure sample
gta_valid |> 
  filter(sample_code == "GTAPure6") |> 
  select(workstation, sample_code, obs_id, variety, ends_with("percent"), result_top) |> 
  pivot_longer(ends_with("percent"), 
               names_to = "result_type",
               values_to = "percentage"
               ) |> 
  mutate(result_type = str_remove(result_type, "_percent"),
         result_type = fct_relevel(result_type, "predicted", "expected")
         ) |> 
  ggplot(aes(result_type, percentage, fill=variety)) +
  geom_bar(position="stack", stat="identity") +
  ggtitle("GTAPure6") + 
  xlab("Result type") + 
  ylab("Percentage identified (%)") + 
  coord_flip() +
  facet_wrap(~workstation) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave(here("outputs/figures/gta_alldevs_pure6_percent.pdf"), width = 6.5, height = 5)


# Admixed samples
gta_valid |> 
  filter(sample_code == "GTAMix4") |> 
  select(workstation, sample_code, obs_id, variety, ends_with("percent"), result_top) |> 
  pivot_longer(ends_with("percent"), 
               names_to = "result_type",
               values_to = "percentage"
               ) |> 
   mutate(result_type = str_remove(result_type, "_percent"),
         result_type = fct_relevel(result_type, "predicted", "expected")
         ) |> 
  ggplot(aes(result_type, percentage, fill=variety)) +
  geom_bar(position="stack", stat="identity") +
  ggtitle("GTAMix4") + 
  xlab("Result type") + 
  ylab("Percentage identified (%)") + 
  coord_flip() +
  facet_wrap(~workstation) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave(here("outputs/figures/gta_alldevs_mix4_percent.pdf"), width = 6.5, height = 5)
```

```{r}
# Retrieve the names of all the pure samples
pure_sample_codes <- gta_valid |> 
  filter(str_detect(sample_code,"Pure")) |> 
  distinct(sample_code) |>
  arrange(sample_code) |> 
  pull()

# Retrieve the names of all the mix samples
mix_sample_codes <- gta_valid |> 
  filter(str_detect(sample_code,"Mix")) |> 
  distinct(sample_code) |>
  arrange(sample_code) |> 
  pull()

stacked_bar_plot_percent_compare <- function(sample_name){
  gta_valid |> 
  filter(sample_code == sample_name) |> 
  select(workstation, sample_code, obs_id, variety, ends_with("percent"), result_top) |> 
  pivot_longer(ends_with("percent"), 
               names_to = "result_type",
               values_to = "percentage"
               ) |> 
   mutate(result_type = str_remove(result_type, "_percent"),
         result_type = fct_relevel(result_type, "predicted", "expected")
         ) |> 
  ggplot(aes(result_type, percentage, fill=variety)) +
  geom_bar(position="stack", stat="identity") +
  ggtitle(sample_name) + 
  coord_flip() +
  facet_wrap(~workstation) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
    )
}

# Make plots for all pure samples
map(pure_sample_codes,
    stacked_bar_plot_percent_compare
    ) |> 
  wrap_plots()

ggsave(here("outputs/figures/gta_allpure_percent.pdf"), width = 20, height = 15)

# Make plots for all mix samples
map(mix_sample_codes,
    stacked_bar_plot_percent_compare
    ) |> 
  wrap_plots()

ggsave(here("outputs/figures/gta_allmix_percent.pdf"), width = 20, height = 15)
```


```{r}
stacked_bar_plot_percent_compare("GTAPure10")

gta_valid |> 
  filter(
    sample_code == "GTAPure10",
    workstation == "Quambatook"
    ) |> 
  count(predicted_percent)
```


### Does classified seeds vary across devices? 

#### Single station and sample

```{r}
gta_valid |> 
  select(workstation, sample_code, classified_seeds) |> 
  filter(sample_code == "GTAPure9") |> 
  ggplot(aes(workstation, classified_seeds)) + 
  geom_point() + 
  coord_flip() +
  ggtitle("GTAPure10") + 
  ylab("Number of classifed seeds") + 
  xlab("Device") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 50, hjust = 1)
  ) 

ggsave(here("outputs/figures/gta_pure10_classified_seeds.pdf"), width = 6.5, height = 5)
```

#### One specific analysis type

```{r}
gta_valid |> 
  select(workstation, sample_code, classified_seeds,sample_type ) |> 
  filter(sample_type == "Mix") |> 
  ggplot(aes(workstation, classified_seeds)) + 
  geom_point() + 
  coord_flip() +
  facet_wrap(~sample_code) +
  ggtitle("Admixed samples") + 
  ylab("Number of classifed seeds") + 
  xlab("Device") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 50, hjust = 1)
  ) 

ggsave(here("outputs/figures/gta_allpure_classified_seeds.pdf"), width = 6.5, height = 5)
```


#### All stations and samples

```{r}
gta_valid |> 
  select(workstation, sample_code, classified_seeds) |> 
  ggplot(aes(workstation, classified_seeds)) + 
  geom_point() + 
  facet_wrap(~sample_code) +
  coord_flip() +
  ylab("Number of classifed seeds") + 
  xlab("Device") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 50, hjust = 1)
  ) 

ggsave(here("outputs/figures/gta_alldev_allsamps_classified_seeds.pdf"), width = 11, height = 10)
```
